<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechOps Log</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            min-height: calc(100vh - 20px);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .login-form, .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-success {
            background: #51cf66;
            color: white;
        }

        .site-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .site-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .site-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .site-card h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .site-card p {
            opacity: 0.9;
            font-size: 14px;
        }

        .job-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .job-card:hover {
            border-color: #4facfe;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .job-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .job-status {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-done {
            background: #d1e7dd;
            color: #0f5132;
        }

        .status-overdue {
            background: #f8d7da;
            color: #721c24;
        }

        .unit-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
        }

        .checkbox-item:last-child {
            border-bottom: none;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .nav-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #4facfe;
            color: white;
        }

        .admin-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .admin-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #e1e5e9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #51cf66 0%, #40c057 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .filter-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .search-bar input {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            width: 100%;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #51cf66;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 480px) {
            .container {
                border-radius: 0;
                min-height: 100vh;
                margin: 0;
            }
            
            .content {
                padding: 15px;
            }
            
            .unit-selector {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .role-main-admin {
            background: #ff6b6b;
            color: white;
        }

        .role-site-admin {
            background: #4dabf7;
            color: white;
        }

        .role-technician {
            background: #69db7c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <div class="container">
        <!-- Login Page -->
        <div class="page active" id="loginPage">
            <div class="header">
                <h1>üîß TechOps Log</h1>
                <div class="subtitle">Property Management System</div>
            </div>
            <div class="content">
                <div class="login-form">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                </div>
            </div>
        </div>

        <!-- Site Selection Page -->
        <div class="page" id="siteSelectionPage">
            <div class="header">
                <h1>Select Site</h1>
                <div class="subtitle">Choose your work location</div>
                <button class="back-btn" onclick="logout()">Logout</button>
            </div>
            <div class="content">
                <div class="site-grid" id="siteGrid">
                    <!-- Sites will be populated here -->
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="page" id="mainDashboard">
            <div class="header">
                <button class="back-btn" onclick="showPage('siteSelectionPage')">‚Üê Back</button>
                <h1 id="currentSiteTitle">Dashboard</h1>
                <div class="subtitle" id="currentUserInfo">Welcome</div>
            </div>
            <div class="content">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('jobs')">Jobs</button>
                    <button class="nav-tab" onclick="showTab('schedule')">Schedule</button>
                    <button class="nav-tab" onclick="showTab('admin')" id="adminTab" style="display:none">Admin</button>
                </div>

                <!-- Jobs Tab -->
                <div class="tab-content active" id="jobsTab">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="pendingCount">0</div>
                            <div class="stat-label">Pending Jobs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completedCount">0</div>
                            <div class="stat-label">Completed Today</div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="showPage('newJobPage')">+ New Job</button>
                    
                    <div class="filter-bar">
                        <div class="search-bar">
                            <input type="text" placeholder="Search jobs..." id="jobSearch" onkeyup="filterJobs()">
                        </div>
                        <div class="filter-row">
                            <select id="statusFilter" onchange="filterJobs()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="done">Done</option>
                                <option value="overdue">Overdue</option>
                            </select>
                            <select id="categoryFilter" onchange="filterJobs()">
                                <option value="">All Categories</option>
                            </select>
                        </div>
                    </div>

                    <div id="jobsList">
                        <!-- Jobs will be populated here -->
                    </div>
                </div>

                <!-- Schedule Tab -->
                <div class="tab-content" id="scheduleTab">
                    <h3>Upcoming Appointments</h3>
                    <div id="scheduleList">
                        <!-- Schedule items will be populated here -->
                    </div>
                </div>

                <!-- Admin Tab -->
                <div class="tab-content" id="adminTab-content">
                    <div class="admin-grid">
                        <button class="btn btn-secondary" onclick="showPage('manageCategoriesPage')">Manage Categories</button>
                        <button class="btn btn-secondary" onclick="showPage('manageUnitsPage')">Manage Units</button>
                        <button class="btn btn-secondary" onclick="showPage('manageTechniciansPage')">Manage Technicians</button>
                        <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                        <button class="btn btn-secondary" onclick="showPage('manageSitesPage')" id="manageSitesBtn" style="display:none">Manage Sites</button>
                        <button class="btn btn-secondary" onclick="showPage('manageAdminsPage')" id="manageAdminsBtn" style="display:none">Manage Admins</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Job Page -->
        <div class="page" id="newJobPage">
            <div class="header">
                <button class="back-btn" onclick="showPage('mainDashboard')">‚Üê Back</button>
                <h1>New Job Entry</h1>
                <div class="subtitle">Record completed work</div>
            </div>
            <div class="content">
                <form id="jobForm">
                    <div class="form-group">
                        <label>Category *</label>
                        <select id="jobCategory" required>
                            <option value="">Select category</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Unit Location *</label>
                        <div class="unit-selector">
                            <div>
                                <label>Block</label>
                                <select id="jobBlock" required onchange="updateUnitNumbers()">
                                    <option value="">Select block</option>
                                </select>
                            </div>
                            <div>
                                <label>Unit Number</label>
                                <select id="jobUnit" required>
                                    <option value="">Select unit</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Description / Remarks *</label>
                        <textarea id="jobDescription" rows="4" placeholder="Describe the work completed..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Person(s) in Charge *</label>
                        <div class="checkbox-group" id="techniciansList">
                            <!-- Technicians will be populated here -->
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Next Appointment (Optional)</label>
                        <input type="datetime-local" id="nextAppointment">
                    </div>

                    <button type="submit" class="btn btn-primary">Save Job</button>
                </form>
            </div>
        </div>

        <!-- Management Pages -->
        <div class="page" id="manageCategoriesPage">
            <div class="header">
                <button class="back-btn" onclick="showPage('mainDashboard')">‚Üê Back</button>
                <h1>Manage Categories</h1>
            </div>
            <div class="content">
                <div class="form-group">
                    <input type="text" id="newCategory" placeholder="Add new category">
                    <button class="btn btn-primary" onclick="addCategory()">Add Category</button>
                </div>
                <div id="categoriesList"></div>
            </div>
        </div>

        <div class="page" id="manageUnitsPage">
            <div class="header">
                <button class="back-btn" onclick="showPage('mainDashboard')">‚Üê Back</button>
                <h1>Manage Units</h1>
            </div>
            <div class="content">
                <div class="form-group">
                    <input type="text" id="newBlock" placeholder="Block name (e.g., Block A)">
                    <input type="number" id="unitCount" placeholder="Number of units" min="1">
                    <button class="btn btn-primary" onclick="addBlock()">Add Block</button>
                </div>
                <div id="blocksList"></div>
            </div>
        </div>

        <div class="page" id="manageTechniciansPage">
            <div class="header">
                <button class="back-btn" onclick="showPage('mainDashboard')">‚Üê Back</button>
                <h1>Manage Technicians</h1>
            </div>
            <div class="content">
                <div class="form-group">
                    <input type="text" id="newTechnician" placeholder="Technician name">
                    <button class="btn btn-primary" onclick="addTechnician()">Add Technician</button>
                </div>
                <div id="techniciansList"></div>
            </div>
        </div>

        <!-- Main Admin Pages -->
        <div class="page" id="manageSitesPage">
            <div class="header">
                <button class="back-btn" onclick="showPage('mainDashboard')">‚Üê Back</button>
                <h1>Manage Sites</h1>
            </div>
            <div class="content">
                <div class="form-group">
                    <input type="text" id="newSiteName" placeholder="Site name">
                    <input type="text" id="newSiteDescription" placeholder="Site description">
                    <button class="btn btn-primary" onclick="addSite()">Add Site</button>
                </div>
                <div id="sitesList"></div>
            </div>
        </div>

        <div class="page" id="manageAdminsPage">
            <div class="header">
                <button class="back-btn" onclick="showPage('mainDashboard')">‚Üê Back</button>
                <h1>Manage Admins</h1>
            </div>
            <div class="content">
                <div class="form-group">
                    <input type="text" id="newAdminUsername" placeholder="Username">
                    <input type="password" id="newAdminPassword" placeholder="Password">
                    <select id="newAdminSite">
                        <option value="">Select site</option>
                    </select>
                    <button class="btn btn-primary" onclick="addAdmin()">Add Site Admin</button>
                </div>
                <div id="adminsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Data Storage
        let appData = {
            users: [
                { username: 'mainadmin', password: 'admin123', role: 'main-admin', siteId: null, enabled: true }
            ],
            sites: [
                { id: 'site1', name: 'Armani Residences', description: 'Luxury Condominium', adminId: null },
                { id: 'site2', name: 'Plaza Apartments', description: 'Residential Complex', adminId: null }
            ],
            categories: {
                'site1': ['Air Conditioning', 'Electrical', 'Leaking', 'Others', 'Painting', 'Plumbing', 'Repairing'],
                'site2': ['Air Conditioning', 'Electrical', 'Leaking', 'Others', 'Painting', 'Plumbing', 'Repairing']
            },
            blocks: {
                'site1': [
                    { name: 'Block A', units: ['01', '02', '03', '04', '05'] },
                    { name: 'Block B', units: ['01', '02', '03', '04', '05'] }
                ],
                'site2': [
                    { name: 'Block 1', units: ['01', '02', '03', '04'] },
                    { name: 'Block 2', units: ['01', '02', '03', '04'] }
                ]
            },
            technicians: {
                'site1': ['Ahmad Rahman', 'Kumar Singh', 'Lim Wei Ming'],
                'site2': ['John Doe', 'Mary Johnson', 'Robert Lee']
            },
            jobs: []
        };

        let currentUser = null;
        let currentSite = null;

        // Initialize app
        function initApp() {
            // Load data from localStorage
            const savedData = localStorage.getItem('techopsData');
            if (savedData) {
                appData = { ...appData, ...JSON.parse(savedData) };
            }
            
            showPage('loginPage');
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('techopsData', JSON.stringify(appData));
        }

        // Authentication
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const user = appData.users.find(u => u.username === username && u.password === password && u.enabled);
            
            if (user) {
                currentUser = user;
                if (user.role === 'main-admin') {
                    populateSites();
                    showPage('siteSelectionPage');
                } else if (user.siteId) {
                    currentSite = user.siteId;
                    showMainDashboard();
                } else {
                    alert('User not assigned to any site. Contact main admin.');
                }
            } else {
                alert('Invalid credentials or account disabled');
            }
        }

        function logout() {
            currentUser = null;
            currentSite = null;
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showPage('loginPage');
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function showTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            if (tabName === 'jobs') {
                updateJobStats();
                populateJobs();
            } else if (tabName === 'schedule') {
                populateSchedule();
            }
        }

        // Site Management
        function populateSites() {
            const siteGrid = document.getElementById('siteGrid');
            siteGrid.innerHTML = '';

            appData.sites.forEach(site => {
                if (currentUser.role === 'main-admin' || currentUser.siteId === site.id) {
                    const siteCard = document.createElement('div');
                    siteCard.className = 'site-card';
                    siteCard.onclick = () => selectSite(site.id);
                    siteCard.innerHTML = `
                        <h3>${site.name}</h3>
                        <p>${site.description}</p>
                    `;
                    siteGrid.appendChild(siteCard);
                }
            });
        }

        function selectSite(siteId) {
            currentSite = siteId;
            showMainDashboard();
        }

        function showMainDashboard() {
            const site = appData.sites.find(s => s.id === currentSite);
            document.getElementById('currentSiteTitle').textContent = site.name;
            document.getElementById('currentUserInfo').textContent = `${currentUser.username} | ${currentUser.role.replace('-', ' ').toUpperCase()}`;

            // Show/hide admin features
            if (currentUser.role === 'main-admin' || currentUser.role === 'site-admin') {
                document.getElementById('adminTab').style.display = 'block';
                if (currentUser.role === 'main-admin') {
                    document.getElementById('manageSitesBtn').style.display = 'block';
                    document.getElementById('manageAdminsBtn').style.display = 'block';
                }
            }

            populateJobForm();
            updateJobStats();
            populateJobs();
            showPage('mainDashboard');
        }

        // Job Management
        function populateJobForm() {
            // Populate categories
            const categorySelect = document.getElementById('jobCategory');
            const categoryFilter = document.getElementById('categoryFilter');
            categorySelect.innerHTML = '<option value="">Select category</option>';
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            if (appData.categories[currentSite]) {
                appData.categories[currentSite].sort().forEach(category => {
                    const option1 = new Option(category, category);
                    const option2 = new Option(category, category);
                    categorySelect.appendChild(option1);
                    categoryFilter.appendChild(option2);
                });
            }

            // Populate blocks
            const blockSelect = document.getElementById('jobBlock');
            blockSelect.innerHTML = '<option value="">Select block</option>';
            
            if (appData.blocks[currentSite]) {
                appData.blocks[currentSite].sort((a, b) => a.name.localeCompare(b.name)).forEach(block => {
                    blockSelect.appendChild(new Option(block.name, block.name));
                });
            }

            // Populate technicians
            const techList = document.getElementById('techniciansList');
            techList.innerHTML = '';
            
            if (appData.technicians[currentSite]) {
                appData.technicians[currentSite].sort().forEach(tech => {
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    div.innerHTML = `
                        <input type="checkbox" id="tech_${tech}" value="${tech}">
                        <label for="tech_${tech}">${tech}</label>
                    `;
                    techList.appendChild(div);
                });
            }
        }

        function updateUnitNumbers() {
            const blockName = document.getElementById('jobBlock').value;
            const unitSelect = document.getElementById('jobUnit');
            unitSelect.innerHTML = '<option value="">Select unit</option>';

            if (blockName && appData.blocks[currentSite]) {
                const block = appData.blocks[currentSite].find(b => b.name === blockName);
                if (block) {
                    block.units.sort().forEach(unit => {
                        unitSelect.appendChild(new Option(unit, unit));
                    });
                }
            }
        }

        function saveJob(event) {
            event.preventDefault();
            
            const category = document.getElementById('jobCategory').value;
            const block = document.getElementById('jobBlock').value;
            const unit = document.getElementById('jobUnit').value;
            const description = document.getElementById('jobDescription').value;
            const nextAppointment = document.getElementById('nextAppointment').value;
            
            const selectedTechs = Array.from(document.querySelectorAll('#techniciansList input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            if (!category || !block || !unit || !description || selectedTechs.length === 0) {
                alert('Please fill all required fields');
                return;
            }

            const job = {
                id: 'job_' + Date.now(),
                siteId: currentSite,
                category,
                block,
                unit,
                description,
                technicians: selectedTechs,
                nextAppointment: nextAppointment || null,
                status: 'done',
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };

            appData.jobs.push(job);
            saveData();

            showNotification('Job saved successfully!');
            
            // Reset form
            document.getElementById('jobForm').reset();
            
            // Go back to dashboard
            showPage('mainDashboard');
            showTab('jobs');
        }

        function updateJobStats() {
            const siteJobs = appData.jobs.filter(j => j.siteId === currentSite);
            const today = new Date().toDateString();
            
            const pendingJobs = siteJobs.filter(j => j.status === 'pending').length;
            const completedToday = siteJobs.filter(j => 
                j.status === 'done' && new Date(j.createdAt).toDateString() === today
            ).length;

            document.getElementById('pendingCount').textContent = pendingJobs;
            document.getElementById('completedCount').textContent = completedToday;
        }

        function populateJobs() {
            const jobsList = document.getElementById('jobsList');
            const siteJobs = appData.jobs.filter(j => j.siteId === currentSite)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            jobsList.innerHTML = '';

            siteJobs.forEach(job => {
                const jobCard = document.createElement('div');
                jobCard.className = 'job-card';
                
                const statusClass = job.status === 'done' ? 'status-done' : 
                                  job.nextAppointment && new Date(job.nextAppointment) < new Date() ? 'status-overdue' : 'status-pending';
                
                const canDelete = (currentUser.role === 'main-admin' || currentUser.role === 'site-admin');
                const deleteBtn = canDelete ? `<button class="btn btn-danger" style="margin-top: 10px; padding: 8px;" onclick="deleteJob('${job.id}')">Delete</button>` : '';
                const markDoneBtn = job.status === 'pending' ? `<button class="btn btn-success" style="margin-top: 10px; padding: 8px; margin-right: 10px;" onclick="markJobDone('${job.id}')">Mark Done</button>` : '';

                jobCard.innerHTML = `
                    <div class="job-header">
                        <div>
                            <strong>${job.category}</strong><br>
                            <small>${job.block} - Unit ${job.unit}</small>
                        </div>
                        <div class="job-status ${statusClass}">
                            ${job.status.toUpperCase()}
                        </div>
                    </div>
                    <p>${job.description}</p>
                    <small><strong>PIC:</strong> ${job.technicians.join(', ')}</small><br>
                    <small><strong>Date:</strong> ${new Date(job.createdAt).toLocaleDateString()}</small><br>
                    <small><strong>By:</strong> ${job.createdBy}</small>
                    ${job.nextAppointment ? `<br><small><strong>Next:</strong> ${new Date(job.nextAppointment).toLocaleString()}</small>` : ''}
                    ${markDoneBtn}${deleteBtn}
                `;
                
                jobsList.appendChild(jobCard);
            });

            if (siteJobs.length === 0) {
                jobsList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No jobs recorded yet. Add your first job!</p>';
            }
        }

        function markJobDone(jobId) {
            const jobIndex = appData.jobs.findIndex(j => j.id === jobId);
            if (jobIndex !== -1) {
                appData.jobs[jobIndex].status = 'done';
                saveData();
                populateJobs();
                updateJobStats();
                showNotification('Job marked as done!');
            }
        }

        function deleteJob(jobId) {
            const reason = prompt('Please provide a reason for deletion:');
            if (reason && reason.trim()) {
                const jobIndex = appData.jobs.findIndex(j => j.id === jobId);
                if (jobIndex !== -1) {
                    // Add deletion record
                    appData.jobs[jobIndex].deletedAt = new Date().toISOString();
                    appData.jobs[jobIndex].deletedBy = currentUser.username;
                    appData.jobs[jobIndex].deleteReason = reason;
                    appData.jobs[jobIndex].status = 'deleted';
                    
                    saveData();
                    populateJobs();
                    updateJobStats();
                    showNotification('Job deleted with reason logged');
                }
            }
        }

        function filterJobs() {
            const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;

            const jobCards = document.querySelectorAll('#jobsList .job-card');
            
            jobCards.forEach(card => {
                const jobText = card.textContent.toLowerCase();
                const matchesSearch = jobText.includes(searchTerm);
                const matchesStatus = !statusFilter || card.querySelector('.job-status').textContent.toLowerCase().includes(statusFilter);
                const matchesCategory = !categoryFilter || jobText.includes(categoryFilter.toLowerCase());

                card.style.display = (matchesSearch && matchesStatus && matchesCategory) ? 'block' : 'none';
            });
        }

        // Schedule Management
        function populateSchedule() {
            const scheduleList = document.getElementById('scheduleList');
            const now = new Date();
            
            const upcomingJobs = appData.jobs
                .filter(j => j.siteId === currentSite && j.nextAppointment && j.status !== 'deleted')
                .sort((a, b) => new Date(a.nextAppointment) - new Date(b.nextAppointment));

            scheduleList.innerHTML = '';

            upcomingJobs.forEach(job => {
                const appointmentDate = new Date(job.nextAppointment);
                const isOverdue = appointmentDate < now;
                
                const scheduleCard = document.createElement('div');
                scheduleCard.className = `job-card ${isOverdue ? 'status-overdue' : ''}`;
                scheduleCard.innerHTML = `
                    <div class="job-header">
                        <div>
                            <strong>${job.category}</strong><br>
                            <small>${job.block} - Unit ${job.unit}</small>
                        </div>
                        <div class="job-status ${isOverdue ? 'status-overdue' : 'status-pending'}">
                            ${isOverdue ? 'OVERDUE' : 'SCHEDULED'}
                        </div>
                    </div>
                    <p><strong>Appointment:</strong> ${appointmentDate.toLocaleString()}</p>
                    <p><strong>PIC:</strong> ${job.technicians.join(', ')}</p>
                    <small><strong>Original Job:</strong> ${job.description.substring(0, 100)}...</small>
                `;
                scheduleList.appendChild(scheduleCard);
            });

            if (upcomingJobs.length === 0) {
                scheduleList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No upcoming appointments scheduled.</p>';
            }
        }

        // Admin Functions
        function addCategory() {
            const categoryName = document.getElementById('newCategory').value.trim();
            if (categoryName) {
                if (!appData.categories[currentSite]) {
                    appData.categories[currentSite] = [];
                }
                if (!appData.categories[currentSite].includes(categoryName)) {
                    appData.categories[currentSite].push(categoryName);
                    appData.categories[currentSite].sort();
                    saveData();
                    populateCategoriesList();
                    populateJobForm();
                    document.getElementById('newCategory').value = '';
                    showNotification('Category added successfully!');
                } else {
                    alert('Category already exists');
                }
            }
        }

        function populateCategoriesList() {
            const categoriesList = document.getElementById('categoriesList');
            categoriesList.innerHTML = '';
            
            if (appData.categories[currentSite]) {
                appData.categories[currentSite].forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'admin-card';
                    categoryItem.innerHTML = `
                        <span>${category}</span>
                        <button class="btn btn-danger" style="float: right; padding: 5px 10px; width: auto;" onclick="removeCategory('${category}')">Remove</button>
                    `;
                    categoriesList.appendChild(categoryItem);
                });
            }
        }

        function removeCategory(categoryName) {
            if (confirm(`Remove category "${categoryName}"?`)) {
                appData.categories[currentSite] = appData.categories[currentSite].filter(c => c !== categoryName);
                saveData();
                populateCategoriesList();
                populateJobForm();
                showNotification('Category removed');
            }
        }

        function addBlock() {
            const blockName = document.getElementById('newBlock').value.trim();
            const unitCount = parseInt(document.getElementById('unitCount').value);
            
            if (blockName && unitCount > 0) {
                if (!appData.blocks[currentSite]) {
                    appData.blocks[currentSite] = [];
                }
                
                const existingBlock = appData.blocks[currentSite].find(b => b.name === blockName);
                if (!existingBlock) {
                    const units = [];
                    for (let i = 1; i <= unitCount; i++) {
                        units.push(i.toString().padStart(2, '0'));
                    }
                    
                    appData.blocks[currentSite].push({ name: blockName, units });
                    appData.blocks[currentSite].sort((a, b) => a.name.localeCompare(b.name));
                    saveData();
                    populateBlocksList();
                    populateJobForm();
                    document.getElementById('newBlock').value = '';
                    document.getElementById('unitCount').value = '';
                    showNotification('Block added successfully!');
                } else {
                    alert('Block already exists');
                }
            }
        }

        function populateBlocksList() {
            const blocksList = document.getElementById('blocksList');
            blocksList.innerHTML = '';
            
            if (appData.blocks[currentSite]) {
                appData.blocks[currentSite].forEach(block => {
                    const blockItem = document.createElement('div');
                    blockItem.className = 'admin-card';
                    blockItem.innerHTML = `
                        <span><strong>${block.name}</strong> (${block.units.length} units: ${block.units.join(', ')})</span>
                        <button class="btn btn-danger" style="float: right; padding: 5px 10px; width: auto;" onclick="removeBlock('${block.name}')">Remove</button>
                    `;
                    blocksList.appendChild(blockItem);
                });
            }
        }

        function removeBlock(blockName) {
            if (confirm(`Remove block "${blockName}" and all its units?`)) {
                appData.blocks[currentSite] = appData.blocks[currentSite].filter(b => b.name !== blockName);
                saveData();
                populateBlocksList();
                populateJobForm();
                showNotification('Block removed');
            }
        }

        function addTechnician() {
            const techName = document.getElementById('newTechnician').value.trim();
            if (techName) {
                if (!appData.technicians[currentSite]) {
                    appData.technicians[currentSite] = [];
                }
                if (!appData.technicians[currentSite].includes(techName)) {
                    appData.technicians[currentSite].push(techName);
                    appData.technicians[currentSite].sort();
                    saveData();
                    populateTechniciansList();
                    populateJobForm();
                    document.getElementById('newTechnician').value = '';
                    showNotification('Technician added successfully!');
                } else {
                    alert('Technician already exists');
                }
            }
        }

        function populateTechniciansList() {
            const techList = document.getElementById('techniciansList');
            techList.innerHTML = '';
            
            if (appData.technicians[currentSite]) {
                appData.technicians[currentSite].forEach(tech => {
                    const techItem = document.createElement('div');
                    techItem.className = 'admin-card';
                    techItem.innerHTML = `
                        <span>${tech}</span>
                        <button class="btn btn-danger" style="float: right; padding: 5px 10px; width: auto;" onclick="removeTechnician('${tech}')">Remove</button>
                    `;
                    techList.appendChild(techItem);
                });
            }
        }

        function removeTechnician(techName) {
            if (confirm(`Remove technician "${techName}"?`)) {
                appData.technicians[currentSite] = appData.technicians[currentSite].filter(t => t !== techName);
                saveData();
                populateTechniciansList();
                populateJobForm();
                showNotification('Technician removed');
            }
        }

        // Main Admin Functions
        function addSite() {
            const siteName = document.getElementById('newSiteName').value.trim();
            const siteDescription = document.getElementById('newSiteDescription').value.trim();
            
            if (siteName && siteDescription) {
                const siteId = 'site' + (appData.sites.length + 1);
                appData.sites.push({
                    id: siteId,
                    name: siteName,
                    description: siteDescription,
                    adminId: null
                });
                
                // Initialize empty arrays for new site
                appData.categories[siteId] = ['Air Conditioning', 'Electrical', 'Leaking', 'Others', 'Painting', 'Plumbing', 'Repairing'];
                appData.blocks[siteId] = [];
                appData.technicians[siteId] = [];
                
                saveData();
                populateSitesList();
                populateAdminSiteSelect();
                document.getElementById('newSiteName').value = '';
                document.getElementById('newSiteDescription').value = '';
                showNotification('Site added successfully!');
            }
        }

        function populateSitesList() {
            const sitesList = document.getElementById('sitesList');
            sitesList.innerHTML = '';
            
            appData.sites.forEach(site => {
                const admin = appData.users.find(u => u.siteId === site.id && u.role === 'site-admin');
                const siteItem = document.createElement('div');
                siteItem.className = 'admin-card';
                siteItem.innerHTML = `
                    <div>
                        <strong>${site.name}</strong><br>
                        <small>${site.description}</small><br>
                        <small>Admin: ${admin ? admin.username : 'Not assigned'}</small>
                    </div>
                    <button class="btn btn-danger" style="float: right; padding: 5px 10px; width: auto;" onclick="removeSite('${site.id}')">Remove</button>
                `;
                sitesList.appendChild(siteItem);
            });
        }

        function removeSite(siteId) {
            if (confirm('Remove this site and all its data?')) {
                appData.sites = appData.sites.filter(s => s.id !== siteId);
                delete appData.categories[siteId];
                delete appData.blocks[siteId];
                delete appData.technicians[siteId];
                appData.jobs = appData.jobs.filter(j => j.siteId !== siteId);
                appData.users = appData.users.filter(u => u.siteId !== siteId);
                
                saveData();
                populateSitesList();
                populateAdminSiteSelect();
                showNotification('Site removed');
            }
        }

        function addAdmin() {
            const username = document.getElementById('newAdminUsername').value.trim();
            const password = document.getElementById('newAdminPassword').value.trim();
            const siteId = document.getElementById('newAdminSite').value;
            
            if (username && password && siteId) {
                const existingUser = appData.users.find(u => u.username === username);
                if (!existingUser) {
                    appData.users.push({
                        username,
                        password,
                        role: 'site-admin',
                        siteId,
                        enabled: true
                    });
                    
                    saveData();
                    populateAdminsList();
                    document.getElementById('newAdminUsername').value = '';
                    document.getElementById('newAdminPassword').value = '';
                    document.getElementById('newAdminSite').value = '';
                    showNotification('Admin added successfully!');
                } else {
                    alert('Username already exists');
                }
            }
        }

        function populateAdminSiteSelect() {
            const select = document.getElementById('newAdminSite');
            select.innerHTML = '<option value="">Select site</option>';
            
            appData.sites.forEach(site => {
                select.appendChild(new Option(site.name, site.id));
            });
        }

        function populateAdminsList() {
            const adminsList = document.getElementById('adminsList');
            adminsList.innerHTML = '';
            
            appData.users.filter(u => u.role === 'site-admin').forEach(admin => {
                const site = appData.sites.find(s => s.id === admin.siteId);
                const adminItem = document.createElement('div');
                adminItem.className = 'admin-card';
                adminItem.innerHTML = `
                    <div>
                        <strong>${admin.username}</strong>
                        <span class="role-badge role-site-admin">Site Admin</span><br>
                        <small>Site: ${site ? site.name : 'Unknown'}</small><br>
                        <small>Status: ${admin.enabled ? 'Enabled' : 'Disabled'}</small>
                    </div>
                    <div>
                        <button class="btn ${admin.enabled ? 'btn-secondary' : 'btn-success'}" style="padding: 5px 10px; width: auto; margin-right: 5px;" onclick="toggleAdmin('${admin.username}')">${admin.enabled ? 'Disable' : 'Enable'}</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; width: auto;" onclick="removeAdmin('${admin.username}')">Remove</button>
                    </div>
                `;
                adminsList.appendChild(adminItem);
            });
        }

        function toggleAdmin(username) {
            const admin = appData.users.find(u => u.username === username);
            if (admin) {
                admin.enabled = !admin.enabled;
                saveData();
                populateAdminsList();
                showNotification(`Admin ${admin.enabled ? 'enabled' : 'disabled'}`);
            }
        }

        function removeAdmin(username) {
            if (confirm(`Remove admin "${username}"?`)) {
                appData.users = appData.users.filter(u => u.username !== username);
                saveData();
                populateAdminsList();
                showNotification('Admin removed');
            }
        }

        // Export Functions
        function exportData() {
            const siteJobs = appData.jobs.filter(j => j.siteId === currentSite && j.status !== 'deleted');
            const site = appData.sites.find(s => s.id === currentSite);
            
            // Calculate KPIs
            const totalJobs = siteJobs.length;
            const completedJobs = siteJobs.filter(j => j.status === 'done').length;
            const pendingJobs = siteJobs.filter(j => j.status === 'pending').length;
            const overdueJobs = siteJobs.filter(j => j.nextAppointment && new Date(j.nextAppointment) < new Date()).length;
            
            // Category breakdown
            const categoryStats = {};
            siteJobs.forEach(job => {
                categoryStats[job.category] = (categoryStats[job.category] || 0) + 1;
            });
            
            // Technician performance
            const technicianStats = {};
            siteJobs.forEach(job => {
                job.technicians.forEach(tech => {
                    technicianStats[tech] = (technicianStats[tech] || 0) + 1;
                });
            });

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header
            csvContent += `TechOps Report - ${site.name}\n`;
            csvContent += `Generated on: ${new Date().toLocaleString()}\n\n`;
            
            // KPI Summary
            csvContent += "KPI SUMMARY\n";
            csvContent += "Metric,Value\n";
            csvContent += `Total Jobs,${totalJobs}\n`;
            csvContent += `Completed Jobs,${completedJobs}\n`;
            csvContent += `Pending Jobs,${pendingJobs}\n`;
            csvContent += `Overdue Jobs,${overdueJobs}\n`;
            csvContent += `Completion Rate,${totalJobs > 0 ? ((completedJobs/totalJobs)*100).toFixed(1) : 0}%\n\n`;
            
            // Category Breakdown
            csvContent += "CATEGORY BREAKDOWN\n";
            csvContent += "Category,Jobs Count\n";
            Object.entries(categoryStats).forEach(([category, count]) => {
                csvContent += `${category},${count}\n`;
            });
            csvContent += "\n";
            
            // Technician Performance
            csvContent += "TECHNICIAN PERFORMANCE\n";
            csvContent += "Technician,Jobs Handled\n";
            Object.entries(technicianStats).forEach(([tech, count]) => {
                csvContent += `${tech},${count}\n`;
            });
            csvContent += "\n";
            
            // Detailed Job List
            csvContent += "DETAILED JOB LIST\n";
            csvContent += "Date,Category,Block,Unit,Description,Technicians,Status,Next Appointment,Created By\n";
            
            siteJobs.forEach(job => {
                const date = new Date(job.createdAt).toLocaleDateString();
                const nextApp = job.nextAppointment ? new Date(job.nextAppointment).toLocaleString() : '';
                const description = job.description.replace(/,/g, ';').replace(/\n/g, ' ');
                csvContent += `${date},"${job.category}","${job.block}","${job.unit}","${description}","${job.technicians.join('; ')}","${job.status}","${nextApp}","${job.createdBy}"\n`;
            });

            // Download file
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `TechOps_Report_${site.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Data exported successfully!');
        }

        // Utility Functions
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Event Listeners
        document.getElementById('jobForm').addEventListener('submit', saveJob);

        // Initialize management pages
        function initManagementPages() {
            if (document.getElementById('manageCategoriesPage').classList.contains('active')) {
                populateCategoriesList();
            } else if (document.getElementById('manageUnitsPage').classList.contains('active')) {
                populateBlocksList();
            } else if (document.getElementById('manageTechniciansPage').classList.contains('active')) {
                populateTechniciansList();
            } else if (document.getElementById('manageSitesPage').classList.contains('active')) {
                populateSitesList();
            } else if (document.getElementById('manageAdminsPage').classList.contains('active')) {
                populateAdminsList();
                populateAdminSiteSelect();
            }
        }

        // Override showPage to initialize management pages
        const originalShowPage = showPage;
        showPage = function(pageId) {
            originalShowPage(pageId);
            if (pageId.includes('manage')) {
                setTimeout(initManagementPages, 100);
            }
        };

        // Initialize app on load
        initApp();

        // Service Worker for notifications (basic setup)
        if ('serviceWorker' in navigator && 'Notification' in window) {
            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Check for overdue appointments every 5 minutes
            setInterval(() => {
                if (currentSite && Notification.permission === 'granted') {
                    const overdueJobs = appData.jobs.filter(j => 
                        j.siteId === currentSite && 
                        j.nextAppointment && 
                        new Date(j.nextAppointment) < new Date() &&
                        j.status === 'pending'
                    );
                    
                    if (overdueJobs.length > 0) {
                        new Notification('TechOps Alert', {
                            body: `You have ${overdueJobs.length} overdue appointment(s)`,
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiByeD0iMTIiIGZpbGw9IiM0ZmFjZmUiLz4KPHN2ZyB4PSIxNiIgeT0iMTYiIHdpZHRoPSIzMiIgaGVpZ2h0PSIzMiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Im0xOS41IDEyIC0xIC4yNWMtLjMgMS4xIDEuMyAyLjc1IDIuMjUgMi43NSAuNyAwIDEuMjUgLS41NSAxLjI1IC0xLjI1IDAtLjQgLS4xNSAtLjc2IC4zOCAxLjEgLS42MiAxLjc2LTEuODggMy0zLjM4IDMtMS4zOCAwLTIuNjUtLjkzLTMuMjItMi4yOHoiLz4KPC9zdmc+Cjwvc3ZnPg=='
                        });
                    }
                }
            }, 300000); // 5 minutes
        }
    </script>
</body>
</html>
